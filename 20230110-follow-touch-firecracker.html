<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <style>
      *,
      *:after,
      *:before {
        box-sizing: border-box;
      }

      body {
        min-height: 100vh;
        cursor: url("money.png"), default;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: none;
        background-color: #04050d;
        overflow: hidden;
      }

      .sparkler {
        position: absolute;
        box-shadow: 0 0 8px 8px rgba(245, 224, 163, 0.08);
      }

      .sparkler__spark {
        --shadow: hsl( 
          var(--h),
          calc(var(--s, 50) * 1%),
          calc(var(--l, 25) * 1%)
        );
        position: absolute;
        height: 8px;
        width: 1.6px;
        box-shadow: 0 0 10px 2px var(--shadow);
        background-color: #fff;
        transform: rotate(calc(var(--rotation) * 1deg)) translate(0, 0);
        animation: spark calc(var(--speed) * 1s) calc(var(--delay) * -1s)
          infinite ease;
        z-index: 2;
      }

      @keyframes spark {
        to {
          opacity: 0;
          transform: rotate(calc(var(--rotation) * 1deg))
            translate(0, calc(var(--travel) * 1px));
        }
      }

      .firecracker {
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        opacity: 1;
      }

      @keyframes fade-out {
        0% {
          opacity: 1;
          transform: translate(0, 0) scale(1);
        }
        100% {
          opacity: 0;
          transform: translate(2%, 2%) scale(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="touch__wrap" id="touchWrap"></div>

    <script>
      const animationDuration = .8;
      const touchWrap = document.querySelector(".touch__wrap");
      
      document.addEventListener("DOMContentLoaded", buildTouchAnimate);

      function randomInRange (min, max) {
        return Math.floor(Math.random() * (max - min) + 1) + min;
      }

      function buildTouchAnimate() {
        // mobile
        document.addEventListener("touchmove", firecrackerTouchMove);

        // web
        document.addEventListener("mousemove", firecrackerMouseMove);
      }

      function removeSparkle(length, remove) {

        let maxLength = 60;
        const childArray = Array.from(touchWrap.childNodes)

        if (childArray.length > maxLength) {
          let newChildArray = childArray.splice(0, maxLength / 2);
          newChildArray.forEach(function (el) { 
            el.remove();
          })
        }
      };

      // 每 5 秒檢查一次
      // 假如 touchWrap 裡的 child nodes 超過 100，就刪除前面 50 個元素
      setInterval(removeSparkle, 1000);

      // 生成火花動畫
      function firecrackerAnimate(e) {

        // 生成隨機
        for (let count = 0; count < 10; count++) {
          e.insertAdjacentHTML('beforeend', `
          <div class="sparkler__spark" style="
            --rotation: ${randomInRange(0, 360)}; 
            --delay: ${Math.random()}; 
            --speed: ${randomInRange(1, 10) / 10}; 
            --travel: ${randomInRange(100, 150)}; 
            --h: ${randomInRange(20, 60)}; 
            --s: ${randomInRange(50, 100)}; 
            --l: ${randomInRange(50, 100)};">
          </div>
        `);
        }

        // 加上淡入淡出動畫
        e.style.animation = `fade-out ${animationDuration}s ease-out forwards`;

        // 新增至頁面上
        touchWrap.appendChild(e);
      }

      // touch move
      function firecrackerTouchMove(touches) {
        
        // 偵測不同手指
        [...touches.changedTouches].forEach((touch) => {
          
          const firecracker = document.createElement("div");

          firecracker.classList.add('sparkler');

          // 生成火花
          firecrackerAnimate(firecracker);
          
          // 偵測 X 與 Y 軸
          firecracker.style.top = `${touch.clientY}px`;
          firecracker.style.left = `${touch.clientX}px`;
        });
      }

      // touch end
      function firecrackerTouchEnd() {
        const delayTime =  animationDuration * 1 * 1000;
        
        // setTimeout( function() {
        //   removeSparkle(touchWrap);
        // }, delayTime);
      };

      function firecrackerMouseMove (e) {
        const firecracker = document.createElement("div");

        firecracker.classList.add('sparkler');

        // 生成火花
        firecrackerAnimate(firecracker);

        // 偵測滑鼠移動位置
        firecracker.style.left = `${e.clientX}px`;
        firecracker.style.top = `${e.clientY}px`;

        firecracker.style.transition = "all 0.5s linear 0s";
        firecracker.style.left = `${firecracker.offsetLeft - 20}px`;
        firecracker.style.top = `${firecracker.offsetTop - 20}px`;
        firecracker.style.opacity = 0;
      }
    </script>
  </body>
</html>
